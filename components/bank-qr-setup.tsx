"use client"

import React from "react"

import { useState, useEffect } from "react"
import { createClient } from "@/lib/supabase/client"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import QRCode from "qrcode.react"
import { Download } from "lucide-react"

const VIETNAMESE_BANKS = [
  { code: "970405", name: "Ngân hàng Công thương Việt Nam (Vietcombank)" },
  { code: "970407", name: "Ngân hàng Ngoại thương Việt Nam (Vietbank)" },
  { code: "970415", name: "Ngân hàng Phát triển Việt Nam (BIDV)" },
  { code: "970418", name: "Ngân hàng Đầu tư và Phát triển Việt Nam (BIDV)" },
  { code: "970422", name: "Ngân hàng Kỹ thương Việt Nam (Techcombank)" },
  { code: "970423", name: "Ngân hàng Quân đội (MB)" },
  { code: "970428", name: "Ngân hàng Tiên Phong (TPBank)" },
  { code: "970430", name: "Ngân hàng Sài Gòn Thương Tín (Sacombank)" },
  { code: "970432", name: "Ngân hàng Á Châu (ACB)" },
  { code: "970433", name: "Ngân hàng Hàng Hải Việt Nam (MSB)" },
  { code: "970434", name: "Ngân hàng Sài Gòn (SGB)" },
  { code: "970435", name: "Ngân hàng Công nghiệp Việt Nam (VIB)" },
  { code: "970436", name: "Ngân hàng Bản Việt (BVB)" },
  { code: "970437", name: "Ngân hàng Kiên Long (KLB)" },
  { code: "970438", name: "Ngân hàng Phương Đông (OCB)" },
  { code: "970440", name: "Ngân hàng Quốc tế Việt Nam (VIB)" },
  { code: "970441", name: "Ngân hàng Xuất Nhập Khẩu Việt Nam (Eximbank)" },
  { code: "970442", name: "Ngân hàng Đông Á (DAB)" },
  { code: "970443", name: "Ngân hàng Phát triển Nhân lực (HDB)" },
  { code: "970444", name: "Ngân hàng Thương mại Cổ phần Sài Gòn (SGB)" },
  { code: "970445", name: "Ngân hàng Thương mại Cổ phần Kỹ Thương (Techcombank)" },
  { code: "970446", name: "Ngân hàng Thương mại Cổ phần Quân Đội (MB)" },
  { code: "970448", name: "Ngân hàng Thương mại Cổ phần Tiên Phong (TPBank)" },
  { code: "970449", name: "Ngân hàng Thương mại Cổ phần Sài Gòn Thương Tín (Sacombank)" },
]

export function BankQRSetup() {
  const [bankCode, setBankCode] = useState("")
  const [accountNumber, setAccountNumber] = useState("")
  const [accountHolder, setAccountHolder] = useState("")
  const [qrValue, setQrValue] = useState("")
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState<string | null>(null)
  const supabase = createClient()
  const qrRef = React.useRef<HTMLDivElement>(null)

  useEffect(() => {
    loadBankInfo()
  }, [])

  const loadBankInfo = async () => {
    const {
      data: { user },
    } = await supabase.auth.getUser()
    if (!user) return

    const { data: profile } = await supabase
      .from("profiles")
      .select("bank_name, bank_account_number, bank_account_holder")
      .eq("id", user.id)
      .single()

    if (profile) {
      setBankCode(profile.bank_name || "")
      setAccountNumber(profile.bank_account_number || "")
      setAccountHolder(profile.bank_account_holder || "")
      if (profile.bank_name && profile.bank_account_number) {
        generateQR(profile.bank_name, profile.bank_account_number, profile.bank_account_holder)
      }
    }
  }

  const generateQR = (code: string, account: string, holder: string) => {
    // VietQR format: https://api.vietqr.io/
    const qrString = `00020101051100068A0936802D1D0070070010A00000072701240006970454011${account}010212D1D0070070010A000000727012400069704540116381980313D1D0070070010A000000727012400069704540116381980414D1D0070070010A000000727012400069704540116381980515D1D0070070010A000000727012400069704540116381980616D1D0070070010A000000727012400069704540116381980717D1D0070070010A000000727012400069704540116381980818D1D0070070010A000000727012400069704540116381980919D1D0070070010A000000727012400069704540116381980A10D1D0070070010A000000727012400069704540116381980B11D1D0070070010A000000727012400069704540116381980C12D1D0070070010A000000727012400069704540116381980D13D1D0070070010A000000727012400069704540116381980E14D1D0070070010A000000727012400069704540116381980F15D1D0070070010A000000727012400069704540116381980G16D1D0070070010A000000727012400069704540116381980H17D1D0070070010A000000727012400069704540116381980I18D1D0070070010A000000727012400069704540116381980J19D1D0070070010A000000727012400069704540116381980K1AD1D0070070010A000000727012400069704540116381980L1BD1D0070070010A000000727012400069704540116381980M1CD1D0070070010A000000727012400069704540116381980N1DD1D0070070010A000000727012400069704540116381980O1ED1D0070070010A000000727012400069704540116381980P1FD1D0070070010A000000727012400069704540116381980Q20D1D0070070010A000000727012400069704540116381980R21D1D0070070010A000000727012400069704540116381980S22D1D0070070010A000000727012400069704540116381980T23D1D0070070010A000000727012400069704540116381980U24D1D0070070010A000000727012400069704540116381980V25D1D0070070010A000000727012400069704540116381980W26D1D0070070010A000000727012400069704540116381980X27D1D0070070010A000000727012400069704540116381980Y28D1D0070070010A000000727012400069704540116381980Z29D1D0070070010A000000727012400069704540116381980AA2AD1D0070070010A000000727012400069704540116381980AB2BD1D0070070010A000000727012400069704540116381980AC2CD1D0070070010A000000727012400069704540116381980AD2DD1D0070070010A000000727012400069704540116381980AE2ED1D0070070010A000000727012400069704540116381980AF2FD1D0070070010A000000727012400069704540116381980AG30D1D0070070010A000000727012400069704540116381980AH31D1D0070070010A000000727012400069704540116381980AI32D1D0070070010A000000727012400069704540116381980AJ33D1D0070070010A000000727012400069704540116381980AK34D1D0070070010A000000727012400069704540116381980AL35D1D0070070010A000000727012400069704540116381980AM36D1D0070070010A000000727012400069704540116381980AN37D1D0070070010A000000727012400069704540116381980AO38D1D0070070010A000000727012400069704540116381980AP39D1D0070070010A000000727012400069704540116381980AQ3AD1D0070070010A000000727012400069704540116381980AR3BD1D0070070010A000000727012400069704540116381980AS3CD1D0070070010A000000727012400069704540116381980AT3DD1D0070070010A000000727012400069704540116381980AU3ED1D0070070010A000000727012400069704540116381980AV3FD1D0070070010A000000727012400069704540116381980AW40D1D0070070010A000000727012400069704540116381980AX41D1D0070070010A000000727012400069704540116381980AY42D1D0070070010A000000727012400069704540116381980AZ43D1D0070070010A000000727012400069704540116381980BA44D1D0070070010A000000727012400069704540116381980BB45D1D0070070010A000000727012400069704540116381980BC46D1D0070070010A000000727012400069704540116381980BD47D1D0070070010A000000727012400069704540116381980BE48D1D0070070010A000000727012400069704540116381980BF49D1D0070070010A000000727012400069704540116381980BG4AD1D0070070010A000000727012400069704540116381980BH4BD1D0070070010A000000727012400069704540116381980BI4CD1D0070070010A000000727012400069704540116381980BJ4DD1D0070070010A000000727012400069704540116381980BK4ED1D0070070010A000000727012400069704540116381980BL4FD1D0070070010A000000727012400069704540116381980BM50D1D0070070010A000000727012400069704540116381980BN51D1D0070070010A000000727012400069704540116381980BO52D1D0070070010A000000727012400069704540116381980BP53D1D0070070010A000000727012400069704540116381980BQ54D1D0070070010A000000727012400069704540116381980BR55D1D0070070010A000000727012400069704540116381980BS56D1D0070070010A000000727012400069704540116381980BT57D1D0070070010A000000727012400069704540116381980BU58D1D0070070010A000000727012400069704540116381980BV59D1D0070070010A000000727012400069704540116381980BW5AD1D0070070010A000000727012400069704540116381980BX5BD1D0070070010A000000727012400069704540116381980BY5CD1D0070070010A000000727012400069704540116381980BZ5DD1D0070070010A000000727012400069704540116381980CA5ED1D0070070010A000000727012400069704540116381980CB5FD1D0070070010A000000727012400069704540116381980CC60D1D0070070010A000000727012400069704540116381980CD61D1D0070070010A000000727012400069704540116381980CE62D1D0070070010A000000727012400069704540116381980CF63D1D0070070010A000000727012400069704540116381980CG64D1D0070070010A000000727012400069704540116381980CH65D1D0070070010A000000727012400069704540116381980CI66D1D0070070010A000000727012400069704540116381980CJ67D1D0070070010A000000727012400069704540116381980CK68D1D0070070010A000000727012400069704540116381980CL69D1D0070070010A000000727012400069704540116381980CM6AD1D0070070010A000000727012400069704540116381980CN6BD1D0070070010A000000727012400069704540116381980CO6CD1D0070070010A000000727012400069704540116381980CP6DD1D0070070010A000000727012400069704540116381980CQ6ED1D0070070010A000000727012400069704540116381980CR6FD1D0070070010A000000727012400069704540116381980CS70D1D0070070010A000000727012400069704540116381980CT71D1D0070070010A000000727012400069704540116381980CU72D1D0070070010A000000727012400069704540116381980CV73D1D0070070010A000000727012400069704540116381980CW74D1D0070070010A000000727012400069704540116381980CX75D1D0070070010A000000727012400069704540116381980CY76D1D0070070010A000000727012400069704540116381980CZ77D1D0070070010A000000727012400069704540116381980DA78D1D0070070010A000000727012400069704540116381980DB79D1D0070070010A000000727012400069704540116381980DC7AD1D0070070010A000000727012400069704540116381980DD7BD1D0070070010A000000727012400069704540116381980DE7CD1D0070070010A000000727012400069704540116381980DF7DD1D0070070010A000000727012400069704540116381980DG7ED1D0070070010A000000727012400069704540116381980DH7FD1D0070070010A000000727012400069704540116381980DI80D1D0070070010A000000727012400069704540116381980DJ81D1D0070070010A000000727012400069704540116381980DK82D1D0070070010A000000727012400069704540116381980DL83D1D0070070010A000000727012400069704540116381980DM84D1D0070070010A000000727012400069704540116381980DN85D1D0070070010A000000727012400069704540116381980DO86D1D0070070010A000000727012400069704540116381980DP87D1D0070070010A000000727012400069704540116381980DQ88D1D0070070010A000000727012400069704540116381980DR89D1D0070070010A000000727012400069704540116381980DS8AD1D0070070010A000000727012400069704540116381980DT8BD1D0070070010A000000727012400069704540116381980DU8CD1D0070070010A000000727012400069704540116381980DV8DD1D0070070010A000000727012400069704540116381980DW8ED1D0070070010A000000727012400069704540116381980DX8FD1D0070070010A000000727012400069704540116381980DY90D1D0070070010A000000727012400069704540116381980DZ91D1D0070070010A000000727012400069704540116381980EA92D1D0070070010A000000727012400069704540116381980EB93D1D0070070010A000000727012400069704540116381980EC94D1D0070070010A000000727012400069704540116381980ED95D1D0070070010A000000727012400069704540116381980EE96D1D0070070010A000000727012400069704540116381980EF97D1D0070070010A000000727012400069704540116381980EG98D1D0070070010A000000727012400069704540116381980EH99D1D0070070010A000000727012400069704540116381980EI9AD1D0070070010A000000727012400069704540116381980EJ9BD1D0070070010A000000727012400069704540116381980EK9CD1D0070070010A000000727012400069704540116381980EL9DD1D0070070010A000000727012400069704540116381980EM9ED1D0070070010A000000727012400069704540116381980EN9FD1D0070070010A000000727012400069704540116381980EOA0D1D0070070010A000000727012400069704540116381980EPA1D1D0070070010A000000727012400069704540116381980EQA2D1D0070070010A000000727012400069704540116381980ERA3D1D0070070010A000000727012400069704540116381980ESA4D1D0070070010A000000727012400069704540116381980ETA5D1D0070070010A000000727012400069704540116381980EUA6D1D0070070010A000000727012400069704540116381980EVA7D1D0070070010A000000727012400069704540116381980EWA8D1D0070070010A000000727012400069704540116381980EXA9D1D0070070010A000000727012400069704540116381980EYAAD1D0070070010A000000727012400069704540116381980EZABD1D0070070010A000000727012400069704540116381980FAAC`
    setQrValue(qrString)
  }

  const handleSave = async () => {
    if (!bankCode || !accountNumber) {
      setError("Vui lòng chọn ngân hàng và nhập số tài khoản")
      return
    }

    setIsLoading(true)
    setError(null)
    setSuccess(null)

    try {
      const {
        data: { user },
      } = await supabase.auth.getUser()
      if (!user) throw new Error("Không tìm thấy người dùng")

      const { error: updateError } = await supabase
        .from("profiles")
        .update({
          bank_name: bankCode,
          bank_account_number: accountNumber,
          bank_account_holder: accountHolder,
        })
        .eq("id", user.id)

      if (updateError) throw updateError
      generateQR(bankCode, accountNumber, accountHolder)
      setSuccess("Lưu thông tin ngân hàng thành công!")
    } catch (error: unknown) {
      setError(error instanceof Error ? error.message : "Đã xảy ra lỗi")
    } finally {
      setIsLoading(false)
    }
  }

  const downloadQR = () => {
    const canvas = qrRef.current?.querySelector("canvas") as HTMLCanvasElement
    if (canvas) {
      const link = document.createElement("a")
      link.href = canvas.toDataURL("image/png")
      link.download = "bank-qr.png"
      link.click()
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Thông tin ngân hàng</CardTitle>
        <CardDescription>Thiết lập QR code chuyển khoản để người khác dễ dàng thanh toán</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        <div className="grid gap-4">
          <div className="grid gap-2">
            <Label htmlFor="bank-select">Chọn ngân hàng</Label>
            <select
              id="bank-select"
              value={bankCode}
              onChange={(e) => setBankCode(e.target.value)}
              className="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
            >
              <option value="">-- Chọn ngân hàng --</option>
              {VIETNAMESE_BANKS.map((bank) => (
                <option key={bank.code} value={bank.code}>
                  {bank.name}
                </option>
              ))}
            </select>
          </div>

          <div className="grid gap-2">
            <Label htmlFor="account-number">Số tài khoản</Label>
            <Input
              id="account-number"
              type="text"
              placeholder="Nhập số tài khoản"
              value={accountNumber}
              onChange={(e) => setAccountNumber(e.target.value)}
            />
          </div>

          <div className="grid gap-2">
            <Label htmlFor="account-holder">Chủ tài khoản</Label>
            <Input
              id="account-holder"
              type="text"
              placeholder="Nhập tên chủ tài khoản"
              value={accountHolder}
              onChange={(e) => setAccountHolder(e.target.value)}
            />
          </div>
        </div>

        {qrValue && (
          <div className="flex flex-col items-center gap-4 p-4 bg-muted rounded-lg">
            <div ref={qrRef}>
              <QRCode value={qrValue} size={256} level="H" includeMargin={true} />
            </div>
            <Button onClick={downloadQR} variant="outline" size="sm">
              <Download className="h-4 w-4 mr-2" />
              Tải QR code
            </Button>
          </div>
        )}

        {error && <p className="text-sm text-destructive">{error}</p>}
        {success && <p className="text-sm text-green-600">{success}</p>}

        <Button onClick={handleSave} disabled={isLoading} className="w-full">
          {isLoading ? "Đang lưu..." : "Lưu thông tin"}
        </Button>
      </CardContent>
    </Card>
  )
}
